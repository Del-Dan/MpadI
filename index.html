<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAYM Store | Elevate Your Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f0f0f',
                            accent: '#C9A227', // Gold-ish for premium feel
                            gray: '#F3F4F6',
                            surface: '#ffffff'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Glassmorphism & Custom Scrollbar */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .glass-dark {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(16px);
            color: white;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Slider Transitions */
        .slide-enter {
            opacity: 0;
            transform: scale(1.05);
        }

        .slide-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 800ms ease, transform 800ms ease;
        }

        .slide-exit {
            opacity: 1;
            transform: scale(1);
        }

        .slide-exit-active {
            opacity: 0;
            transform: scale(1.05);
            transition: opacity 800ms ease, transform 800ms ease;
        }
    </style>
</head>

<body class="bg-white text-brand-dark font-sans antialiased selection:bg-black selection:text-white">

    <!-- ================= AUTH STATE & CONFIG ================= -->
    <script>
        // REPLACE THIS WITH YOUR DEPLOYED WEB APP URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzxG09tYFfcV7ben74vi6TjQXnqZ6DB3hLnW7PVMRoW24BaQpnqvyH6GZ48A8GO38kc/exec";

        const AppState = {
            user: JSON.parse(localStorage.getItem('faym_user')) || null,
            favorites: [], // Loaded from API
            cart: JSON.parse(localStorage.getItem('faym_cart')) || [],
            products: [],
            inventory: [],
            config: {},
            locations: [],
            currency: 'GH₵'
        };

        // Utility: Google Drive Image Formatter
        const formatImage = (url) => {
            if (!url) return 'https://via.placeholder.com/400x500?text=No+Image';
            try {
                if (url.includes('drive.google.com')) {
                    const idMatch = url.match(/\/d\/(.+?)\//);
                    if (idMatch && idMatch[1]) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
                }
                return url;
            } catch (e) { return url; }
        };
    </script>

    <!-- ================= HEADER ================= -->
    <header class="fixed w-full z-50 glass transition-all duration-300" id="mainHeader">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">

                <!-- Left: Search & Menu (Mobile) -->
                <div class="flex items-center gap-4">
                    <button onclick="toggleSearch()" class="p-2 hover:bg-gray-100 rounded-full transition">
                        <i class="bi bi-search text-xl"></i>
                    </button>
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden p-2" onclick="alert('Menu')"><i class="bi bi-list text-2xl"></i></button>
                </div>

                <!-- Center: Logo -->
                <a href="#" onclick="window.location.reload()" class="flex flex-col items-center group">
                    <h1 class="font-bold text-3xl tracking-tighter leading-none group-hover:opacity-80 transition">FAYM
                    </h1>
                </a>

                <!-- Right: Auth & Cart -->
                <div class="flex items-center gap-4">
                    <!-- Auth Button -->
                    <button onclick="handleAuthClick()" class="p-2 hover:bg-gray-100 rounded-full transition relative">
                        <i class="bi bi-person text-xl" id="authIcon"></i>
                        <span id="authStatusDot"
                            class="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full hidden"></span>
                    </button>

                    <!-- Cart Button -->
                    <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full transition relative group">
                        <i class="bi bi-bag text-xl group-hover:hidden"></i>
                        <i class="bi bi-bag-fill text-xl hidden group-hover:block"></i>
                        <span id="cartCount"
                            class="absolute -top-0 -right-0 bg-brand-dark text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center opacity-0 transition-opacity">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ================= SEARCH OVERLAY ================= -->
    <div id="searchOverlay"
        class="fixed inset-0 bg-white/95 z-[60] hidden flex-col transition-all duration-300 opacity-0 translate-y-[-10px]">
        <div class="max-w-4xl mx-auto w-full p-6 mt-20">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-serif">Search</h2>
                <button onclick="toggleSearch()" class="text-4xl hover:rotate-90 transition">&times;</button>
            </div>

            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search products, colors, styles..."
                    class="w-full text-2xl border-b-2 border-gray-200 py-4 focus:outline-none focus:border-black transition bg-transparent"
                    onkeyup="performSearch(this.value)">
                <i class="bi bi-arrow-right absolute right-0 top-1/2 -translate-y-1/2 text-2xl text-gray-400"></i>
            </div>

            <!-- Filters -->
            <div class="mt-8 flex flex-wrap gap-4">
                <select id="filterCategory" onchange="runFilters()"
                    class="px-4 py-2 border rounded-full hover:border-black transition cursor-pointer bg-white">
                    <option value="all">All Categories</option>
                    <!-- Populated dynamically -->
                </select>
                <select id="filterPrice" onchange="runFilters()"
                    class="px-4 py-2 border rounded-full hover:border-black transition cursor-pointer bg-white">
                    <option value="all">Any Price</option>
                    <option value="under100">Under GH₵100</option>
                    <option value="100to300">GH₵100 - GH₵300</option>
                    <option value="over300">Over GH₵300</option>
                </select>
                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="filterStock" onchange="runFilters()" class="accent-black w-5 h-5">
                        <span>In Stock Only</span>
                    </label>
                </div>
                <button onclick="resetFilters()" class="text-red-500 text-sm hover:underline ml-auto">Reset
                    Filters</button>
            </div>

            <!-- Results -->
            <div id="searchResults"
                class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-6 max-h-[50vh] overflow-y-auto no-scrollbar">
                <!-- Results go here -->
            </div>
        </div>
    </div>

    <!-- ================= HERO SLIDER ================= -->
    <div id="heroSection" class="relative h-[85vh] w-full overflow-hidden bg-gray-100">
        <!-- Slides Container -->
        <div id="sliderContainer" class="absolute inset-0 w-full h-full">
            <!-- Populated by JS -->
        </div>

        <!-- content overlay -->
        <div
            class="absolute inset-x-0 bottom-0 pb-20 pt-40 bg-gradient-to-t from-black/60 to-transparent flex flex-col items-center justify-center text-center px-4 z-10 pointer-events-none">
            <h2 id="heroTitle"
                class="text-4xl md:text-6xl font-serif text-white mb-4 drop-shadow-xl translate-y-4 opacity-0 transition-all duration-700">
            </h2>
            <p id="heroSubtitle"
                class="text-white/90 text-lg mb-8 max-w-md mx-auto translate-y-4 opacity-0 transition-all duration-700 delay-100">
            </p>
            <button onclick="scrollToGrid()"
                class="pointer-events-auto bg-white text-black px-8 py-3 rounded-full font-semibold hover:bg-brand-accent hover:text-white transition-all transform hover:scale-105 shadow-lg translate-y-4 opacity-0 transition-all duration-700 delay-200"
                id="heroBtn">
                Explore Collection
            </button>
        </div>

        <!-- Controls -->
        <button onclick="changeSlide(-1)"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white text-4xl p-2 z-20"><i
                class="bi bi-chevron-left"></i></button>
        <button onclick="changeSlide(1)"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white text-4xl p-2 z-20"><i
                class="bi bi-chevron-right"></i></button>

        <!-- Dots -->
        <div id="sliderDots" class="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-3 z-20">
            <!-- Dots -->
        </div>
    </div>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

        <!-- Section Header -->
        <div class="flex justify-between items-end mb-12">
            <div>
                <span class="text-xs font-bold tracking-widest text-brand-accent uppercase mb-2 block">New
                    Arrivals</span>
                <h2 class="text-3xl md:text-4xl font-serif">Latest Drops</h2>
            </div>
            <!-- Filter Toggles (Desktop) -->
            <div class="hidden md:flex gap-4">
                <button onclick="filterGrid('all')"
                    class="text-sm font-semibold border-b-2 border-black pb-1">All</button>
                <button onclick="filterGrid('T-Shirt')"
                    class="text-sm text-gray-500 hover:text-black transition">T-Shirts</button>
                <button onclick="filterGrid('Hoodie')"
                    class="text-sm text-gray-500 hover:text-black transition">Hoodies</button>
            </div>
        </div>

        <!-- Product Grid -->
        <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-y-12 gap-x-8">
            <!-- Loading State -->
            <div class="col-span-full py-20 flex justify-center">
                <div class="loader"></div>
            </div>
        </div>

    </main>

    <!-- ================= WHATSAPP FLOATING BUTTON ================= -->
    <a href="https://wa.me/233535284878?text=Hello%20FAYM%20Store%2C%20I'm%20interested%20in%20your%20products."
        target="_blank"
        class="fixed bottom-6 right-6 bg-[#25D366] text-white p-4 rounded-full shadow-2xl z-40 hover:scale-110 transition-transform flex items-center justify-center">
        <i class="bi bi-whatsapp text-2xl"></i>
    </a>

    <!-- ================= CART DRAWER ================= -->
    <div id="cartDrawer"
        class="fixed inset-y-0 right-0 w-full sm:w-[400px] bg-white shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <h2 class="text-xl font-bold font-serif">Shopping Cart</h2>
            <button onclick="toggleCart()" class="text-2xl hover:text-gray-500">&times;</button>
        </div>

        <div id="cartItems" class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Items go here -->
            <div class="text-center text-gray-500 mt-20">Your cart is empty.</div>
        </div>

        <div class="p-6 border-t bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-600">Subtotal</span>
                <span id="cartSubtotal" class="font-bold text-xl">GH₵0</span>
            </div>
            <p class="text-xs text-gray-500 mb-4 text-center">Shipping calculated at checkout.</p>
            <button onclick="checkout()"
                class="w-full bg-black text-white py-4 rounded-lg font-bold hover:bg-gray-800 transition">
                Checkout
            </button>
        </div>
    </div>
    <div onclick="toggleCart()" id="cartBackdrop"
        class="fixed inset-0 bg-black/50 z-[65] hidden transition-opacity opacity-0"></div>

    <!-- ================= PRODUCT MODAL ================= -->
    <div id="productModal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div
            class="bg-white w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl z-10 relative flex flex-col md:flex-row max-h-[90vh]">

            <button onclick="closeModal()"
                class="absolute top-4 right-4 z-20 bg-white/50 p-2 rounded-full hover:bg-white transition"><i
                    class="bi bi-x-lg"></i></button>

            <!-- Gallery (Left) -->
            <div class="w-full md:w-1/2 bg-gray-100 relative h-[40vh] md:h-auto group">
                <img id="modalImg" src="" class="w-full h-full object-cover" alt="Product">
                <!-- Simple Gallery Nav if needed, for update -->
            </div>

            <!-- Details (Right) -->
            <div class="w-full md:w-1/2 p-8 md:p-12 overflow-y-auto bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <span id="modalCategory"
                            class="text-xs font-bold text-brand-accent uppercase tracking-wider">Category</span>
                        <h2 id="modalTitle" class="text-3xl font-serif mt-1 mb-2">Product Name</h2>
                        <div class="flex items-center gap-3">
                            <span id="modalPrice" class="text-xl font-bold">GH₵0</span>
                            <span id="modalOldPrice" class="text-sm text-gray-400 line-through hidden">GH₵0</span>
                        </div>
                    </div>
                    <!-- Like Button -->
                    <button onclick="toggleLikeFromModal()" id="modalLikeBtn"
                        class="text-2xl text-gray-300 hover:text-red-500 transition">
                        <i class="bi bi-heart"></i>
                    </button>
                </div>

                <div class="mt-8 space-y-6">
                    <!-- Color Selection -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Select Color: <span id="selectedColorName"
                                    class="text-black"></span></span>
                        </div>
                        <div id="modalColors" class="flex gap-3">
                            <!-- Colors injected here -->
                        </div>
                    </div>

                    <!-- Size Selection -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Select Size</span>
                            <button onclick="openSizeGuide()"
                                class="text-xs underline text-gray-500 hover:text-black">Size Guide</button>
                        </div>
                        <div id="modalSizes" class="grid grid-cols-4 gap-2">
                            <!-- Sizes injected here -->
                        </div>
                    </div>

                    <!-- Description -->
                    <p id="modalDesc" class="text-gray-600 leading-relaxed text-sm"></p>

                    <!-- Add to Cart -->
                    <button id="addToCartBtn" onclick="addToCartFromModal()" disabled
                        class="w-full py-4 bg-gray-200 text-gray-400 font-bold rounded-lg transition-all text-sm uppercase tracking-wide cursor-not-allowed">
                        Select Options
                    </button>
                    <p id="modalStockMsg" class="text-center text-xs text-red-500 mt-2 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= AUTH MODAL ================= -->
    <div id="authModal" class="fixed inset-0 z-[90] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAuth()"></div>
        <div class="bg-white w-full max-w-md rounded-2xl p-8 z-10 relative shadow-2xl slide-up-animation">
            <div id="authForms">
                <!-- LOGIN FORM -->
                <div id="loginForm">
                    <h2 class="text-2xl font-serif mb-6 text-center">Welcome Back</h2>
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <input type="email" name="email" placeholder="Email Address" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <input type="password" name="password" placeholder="Password" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <button type="submit"
                            class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">Log
                            In</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Don't have an account? <button onclick="switchAuth('register')"
                            class="text-black underline font-bold">Sign Up</button>
                    </p>
                    <p class="mt-2 text-center text-sm">
                        <button onclick="switchAuth('reset')" class="text-gray-400 hover:text-black">Forgot
                            Password?</button>
                    </p>
                </div>

                <!-- REGISTER FORM -->
                <div id="registerForm" class="hidden">
                    <h2 class="text-2xl font-serif mb-6 text-center">Create Account</h2>
                    <form onsubmit="handleRegister(event)" class="space-y-4">
                        <input type="text" name="fullName" placeholder="Full Name" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <input type="email" name="email" placeholder="Email Address" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <input type="tel" name="phone" placeholder="Phone Number" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <input type="password" name="password" placeholder="Password (Min 6 chars)" required
                            minlength="6" class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <div class="text-xs text-gray-500">Pass must contain number & special char.</div>
                        <button type="submit"
                            class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">Sign
                            Up</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Already have an account? <button onclick="switchAuth('login')"
                            class="text-black underline font-bold">Log In</button>
                    </p>
                </div>

                <!-- RESET FORM -->
                <div id="resetForm" class="hidden">
                    <h2 class="text-2xl font-serif mb-6 text-center">Reset Password</h2>
                    <p class="text-sm text-gray-500 mb-4 text-center">Enter your email to receive a reset link.</p>
                    <form onsubmit="handleReset(event)" class="space-y-4">
                        <input type="email" name="email" placeholder="Email Address" required
                            class="w-full p-3 border rounded-lg focus:border-black outline-none">
                        <button type="submit"
                            class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">Send
                            Link</button>
                    </form>
                    <p class="mt-4 text-center text-sm">
                        <button onclick="switchAuth('login')" class="text-black underline">Back to Login</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LOGIC SCRIPT ================= -->
    <script>
        // --- 1. INITIALIZATION & DATA FETCHING ---
        document.addEventListener('DOMContentLoaded', async () => {
            initApp();
        });

        async function initApp() {
            renderCartCount();
            checkSession();

            try {
                const response = await fetch(`${API_URL}?action=getStoreData`);
                const data = await response.json();

                AppState.products = data.products;
                AppState.inventory = data.inventory;
                AppState.config = data.config;
                AppState.locations = data.locations;

                initializeHero();
                renderProductGrid();
                populateFilters();

                // If logged in, fetch likes
                if (AppState.user) fetchLikes();

            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('productGrid').innerHTML = `<div class="col-span-full text-center text-red-500">Failed to load store. Please refresh.</div>`;
            }
        }

        // --- 2. AUTHENTICATION LOGIC ---
        function checkSession() {
            if (AppState.user) {
                document.getElementById('authIcon').className = "bi bi-person-fill";
                document.getElementById('authStatusDot').classList.remove('hidden');
            }
        }

        function handleAuthClick() {
            if (AppState.user) {
                // Already logged in -> Show Profile / Logout Options
                if (confirm(`Logged in as ${AppState.user.fullName}. Logout?`)) {
                    logoutUser();
                }
            } else {
                openAuth();
            }
        }

        function openAuth() { document.getElementById('authModal').classList.remove('hidden'); document.getElementById('authModal').classList.add('flex'); }
        function closeAuth() { document.getElementById('authModal').classList.add('hidden'); document.getElementById('authModal').classList.remove('flex'); }

        function switchAuth(mode) {
            ['loginForm', 'registerForm', 'resetForm'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`${mode}Form`).classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Verifying...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'loginUser', payload: { email, password } })
                }).then(r => r.json());

                if (res.success) {
                    AppState.user = res.user;
                    localStorage.setItem('faym_user', JSON.stringify(res.user));
                    checkSession();
                    closeAuth();
                    initApp(); // re-fetch likes
                } else {
                    alert(res.message);
                }
            } catch (err) { alert("Login failed."); }

            btn.innerText = originalText;
            btn.disabled = false;
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;

            // Password Complexity Check
            const pw = form.password.value;
            if (!/\d/.test(pw) || !/[!@#$%^&*]/.test(pw) || !/[A-Z]/.test(pw)) {
                alert("Password must contain at least one number, one special character, and one uppercase letter.");
                return;
            }

            const payload = {
                action: 'registerUser',
                payload: {
                    fullName: form.fullName.value,
                    email: form.email.value,
                    phone: form.phone.value,
                    password: pw
                }
            };

            const btn = form.querySelector('button');
            btn.innerText = "Creating...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json());
                if (res.success) {
                    alert("Account Created! Please login.");
                    switchAuth('login');
                } else {
                    alert(res.message);
                }
            } catch (err) { alert("Registration failed."); }

            btn.innerText = "Sign Up";
            btn.disabled = false;
        }

        function logoutUser() {
            AppState.user = null;
            AppState.favorites = [];
            localStorage.removeItem('faym_user');
            window.location.reload();
        }

        // --- 3. LIKES SYSTEM ---
        async function fetchLikes() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLikes', payload: { email: AppState.user.email } })
                }).then(r => r.json());
                if (res.success) AppState.favorites = res.likes;
            } catch (e) { console.error(e); }
        }

        async function toggleLikeFromModal() {
            if (!AppState.selectedProduct) return;
            // Use subcode if selected, or parent? Likes are per sub-product/style usually?
            // User requested: "liked 3 things... repeat in sheet".
            // Let's like the SPECIFIC STYLE (SubCode).

            if (!AppState.user) {
                alert("Please login to save favorites.");
                openAuth();
                return;
            }

            const subCode = AppState.selectedProduct.sub_code;
            const isLiked = AppState.favorites.includes(subCode);

            // Optimistic UI Update
            const icon = document.getElementById('modalLikeBtn').querySelector('i');
            if (isLiked) {
                AppState.favorites = AppState.favorites.filter(c => c !== subCode);
                icon.className = "bi bi-heart";
                icon.parentElement.classList.remove('text-red-500');
            } else {
                AppState.favorites.push(subCode);
                icon.className = "bi bi-heart-fill";
                icon.parentElement.classList.add('text-red-500');
            }

            // API Call
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'toggleLike',
                    payload: { email: AppState.user.email, productSubCode: subCode }
                })
            });
        }


        // --- 4. HERO SLIDER ---
        let currentSlide = 0;
        let slides = [];
        let autoSlideInterval;

        function initializeHero() {
            // Parse slides from config
            const config = AppState.config;
            slides = [];

            for (let i = 1; i <= 5; i++) {
                if (config[`hero_slide_${i}_url`] && config[`hero_slide_${i}_url`] !== "") {
                    slides.push({
                        type: config[`hero_slide_${i}_type`] || 'image',
                        url: formatImage(config[`hero_slide_${i}_url`]),
                        text: config[`hero_slide_${i}_text`] || '',
                        subtext: config[`hero_slide_${i}_subtext`] || ''
                    });
                }
            }

            if (slides.length === 0) {
                document.getElementById('heroSection').classList.add('hidden');
                return;
            }

            renderSlide(0);
            startAutoSlide();
        }

        function renderSlide(index) {
            const container = document.getElementById('sliderContainer');
            const data = slides[index];

            // Build Media Layer
            let mediaHtml = '';
            if (data.type === 'video') {
                mediaHtml = `<video 
                    src="${data.url}" 
                    class="w-full h-full object-cover transition-transform duration-[2000ms]" 
                    autoplay muted loop playsinline
                ></video>`;
            } else {
                mediaHtml = `<img 
                    src="${data.url}" 
                    class="w-full h-full object-cover animate-fade-in" 
                >`;
            }

            container.innerHTML = mediaHtml;

            // Update Text with Animation Reset
            const titleEl = document.getElementById('heroTitle');
            const subtitleEl = document.getElementById('heroSubtitle');

            // Reset anims
            titleEl.classList.remove('opacity-100', 'translate-y-0');
            titleEl.classList.add('opacity-0', 'translate-y-4');

            setTimeout(() => {
                titleEl.textContent = data.text;
                subtitleEl.textContent = data.subtext;

                // Trigger Anim
                titleEl.classList.remove('opacity-0', 'translate-y-4');
                titleEl.classList.add('opacity-100', 'translate-y-0');

                // Only show background if text exists?
                // Logic: If blank text, maybe hide overlay entirely? 
                // Currently handled by opacity.
            }, 100);
        }

        function changeSlide(dir) {
            currentSlide += dir;
            if (currentSlide >= slides.length) currentSlide = 0;
            if (currentSlide < 0) currentSlide = slides.length - 1;
            renderSlide(currentSlide);
            resetAutoSlide();
        }

        function startAutoSlide() {
            autoSlideInterval = setInterval(() => changeSlide(1), 6000);
        }
        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        }
        // Touch support can be added with touchstart/touchend listeners on heroSection

        // --- 5. PRODUCT GRID & LOGIC ---
        function renderProductGrid(filterFn = null) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            // Group Products by Parent Code
            const parents = {};
            AppState.products.forEach(p => {
                if (!parents[p.parent_code]) {
                    parents[p.parent_code] = { main: p, variants: [] };
                }
                parents[p.parent_code].variants.push(p);
            });

            const renderList = Object.values(parents).map(p => p.main).filter(p => filterFn ? filterFn(p) : true);

            if (renderList.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No products found.</div>`;
                return;
            }

            renderList.forEach(product => {
                const group = parents[product.parent_code];

                // Color Dots Logic
                let dotsHtml = '';
                group.variants.forEach(v => {
                    dotsHtml += `<div class="w-4 h-4 rounded-full border border-gray-200" style="background-color: ${v.color_hex};" title="${v.color_name}"></div>`;
                });

                const card = document.createElement('div');
                card.className = "group cursor-pointer";
                card.onclick = () => openProductModal(product); // Defaults to first variant

                card.innerHTML = `
                    <div class="relative w-full aspect-[4/5] bg-gray-100 overflow-hidden mb-4 rounded-sm">
                        <img src="${formatImage(product.main_image_url)}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" alt="${product.product_name}">
                        ${product.discount_active ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 uppercase tracking-wider">Sale</span>` : ''}
                        
                        <div class="absolute bottom-0 left-0 right-0 p-4 translate-y-full group-hover:translate-y-0 transition duration-300">
                             <button class="w-full bg-white text-black py-3 font-semibold text-sm hover:bg-black hover:text-white transition">View Options</button>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="font-bold text-lg leading-tight group-hover:underline decoration-1 underline-offset-4">${product.product_name}</h3>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
                             ${product.discount_active
                        ? `<span class="font-bold text-red-600">${AppState.currency}${product.discount_price}</span> <span class="line-through text-xs">${AppState.currency}${product.base_price}</span>`
                        : `<span class="font-bold">${AppState.currency}${product.base_price}</span>`
                    }
                        </div>
                        <div class="flex gap-2 items-center opacity-80">
                            ${dotsHtml}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 6. PRODUCT MODAL LOGIC ---
        let currentModalGroup = [];
        let currentVariant = null;

        function openProductModal(product) {
            // Find all variants for this parent
            const allProducts = AppState.products;
            currentModalGroup = allProducts.filter(p => p.parent_code === product.parent_code);

            // Set initial variant (the one clicked, or first)
            selectVariant(product.sub_code);

            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('productModal').classList.add('hidden');
            document.getElementById('productModal').classList.remove('flex');
            resetModalState();
        }

        function selectVariant(subCode) {
            currentVariant = currentModalGroup.find(p => p.sub_code === subCode);
            AppState.selectedProduct = currentVariant; // For Likes logic

            // Update UI
            document.getElementById('modalImg').src = formatImage(currentVariant.main_image_url);
            document.getElementById('modalCategory').innerText = currentVariant.category;
            document.getElementById('modalTitle').innerText = currentVariant.product_name;
            document.getElementById('modalDesc').innerText = currentVariant.description;

            // Price
            const priceEl = document.getElementById('modalPrice');
            const oldPriceEl = document.getElementById('modalOldPrice');
            if (currentVariant.discount_active) {
                priceEl.innerText = `${AppState.currency}${currentVariant.discount_price}`;
                priceEl.classList.add('text-red-600');
                oldPriceEl.innerText = `${AppState.currency}${currentVariant.base_price}`;
                oldPriceEl.classList.remove('hidden');
            } else {
                priceEl.innerText = `${AppState.currency}${currentVariant.base_price}`;
                priceEl.classList.remove('text-red-600');
                oldPriceEl.classList.add('hidden');
            }

            // Colors
            const colorContainer = document.getElementById('modalColors');
            colorContainer.innerHTML = '';
            currentModalGroup.forEach(v => {
                const isSelected = v.sub_code === subCode;
                const dot = document.createElement('button');
                dot.className = `w-10 h-10 rounded-full border-2 transition relative ${isSelected ? 'border-black scale-110' : 'border-transparent hover:scale-105'}`;
                dot.style.backgroundColor = v.color_hex;
                dot.onclick = () => selectVariant(v.sub_code);

                if (isSelected) document.getElementById('selectedColorName').innerText = v.color_name;

                colorContainer.appendChild(dot);
            });

            // Update Favorite Status
            const likeIcon = document.getElementById('modalLikeBtn').querySelector('i');
            if (AppState.favorites.includes(subCode)) {
                likeIcon.className = "bi bi-heart-fill";
                likeIcon.parentElement.classList.add('text-red-500');
            } else {
                likeIcon.className = "bi bi-heart";
                likeIcon.parentElement.classList.remove('text-red-500');
            }

            // Sizes (Check Stock)
            renderSizesForVariant(currentVariant);
        }

        function renderSizesForVariant(variant) {
            const sizeContainer = document.getElementById('modalSizes');
            sizeContainer.innerHTML = '';

            // Define Standard Sizes Order
            const sizeOrder = ['S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL'];

            // Get stock for this variant
            const stockItems = AppState.inventory.filter(i => i.sub_code === variant.sub_code);

            sizeOrder.forEach(size => {
                const stockItem = stockItems.find(i => i.size === size);
                const stockQty = stockItem ? stockItem.stock_qty : 0;
                const isOOS = stockQty <= 0;

                const btn = document.createElement('button');
                btn.innerText = size;
                btn.className = `py-3 rounded border text-sm font-semibold transition ${isOOS
                        ? 'border-gray-100 text-gray-300 cursor-not-allowed bg-gray-50'
                        : 'border-gray-200 hover:border-black hover:bg-black hover:text-white'
                    }`;
                if (isOOS) {
                    btn.disabled = true;
                    btn.title = "Out of Stock";
                } else {
                    btn.onclick = () => selectSize(size, stockItem.sku_id, stockQty, btn);
                }
                sizeContainer.appendChild(btn);
            });

            // Reset Add Button
            const addBtn = document.getElementById('addToCartBtn');
            addBtn.innerText = "Select Size";
            addBtn.disabled = true;
            addBtn.className = "w-full py-4 bg-gray-200 text-gray-400 font-bold rounded-lg transition-all text-sm uppercase tracking-wide cursor-not-allowed";
        }

        let selectedSizeData = null;

        function selectSize(size, sku, maxQty, btnElement) {
            // Visual Selection
            const allBtns = document.getElementById('modalSizes').children;
            Array.from(allBtns).forEach(b => {
                if (!b.disabled) {
                    b.classList.remove('bg-black', 'text-white', 'border-black');
                    b.classList.add('border-gray-200');
                }
            });
            btnElement.classList.add('bg-black', 'text-white', 'border-black');

            selectedSizeData = { size, sku, maxQty };

            // Enable Add Button
            const addBtn = document.getElementById('addToCartBtn');
            addBtn.innerText = `Add to Cart - ${AppState.currency}${currentVariant.discount_active ? currentVariant.discount_price : currentVariant.base_price}`;
            addBtn.disabled = false;
            addBtn.className = "w-full py-4 bg-black text-white font-bold rounded-lg transition-all text-sm uppercase tracking-wide hover:shadow-lg hover:scale-[1.02]";
        }

        function addToCartFromModal() {
            if (!selectedSizeData || !currentVariant) return;

            addItemToCart({
                sku: selectedSizeData.sku,
                parent_code: currentVariant.parent_code,
                product_name: currentVariant.product_name,
                image: currentVariant.main_image_url,
                color: currentVariant.color_name,
                size: selectedSizeData.size,
                price: currentVariant.discount_active ? currentVariant.discount_price : currentVariant.base_price,
                maxQty: selectedSizeData.maxQty,
                qty: 1
            });

            closeModal();
            toggleCart(); // Auto open cart
        }

        function resetModalState() {
            selectedSizeData = null;
        }


        // --- 7. CART SYSTEM ---
        function addItemToCart(newItem) {
            // Check if exists
            const existing = AppState.cart.find(c => c.sku === newItem.sku);
            if (existing) {
                if (existing.qty + 1 <= existing.maxQty) {
                    existing.qty++;
                } else {
                    alert("Max stock reached for this item.");
                }
            } else {
                AppState.cart.push(newItem);
            }
            saveCart();
        }

        function saveCart() {
            localStorage.setItem('faym_cart', JSON.stringify(AppState.cart));
            renderCartCount();
            renderCartDrawer();
        }

        function renderCartCount() {
            const count = AppState.cart.reduce((a, b) => a + b.qty, 0);
            const badge = document.getElementById('cartCount');
            badge.innerText = count;
            badge.classList.toggle('opacity-0', count === 0);
        }

        function toggleCart() {
            const drawer = document.getElementById('cartDrawer');
            const backdrop = document.getElementById('cartBackdrop');
            const isClosed = drawer.classList.contains('translate-x-full');

            if (isClosed) {
                renderCartDrawer();
                drawer.classList.remove('translate-x-full');
                backdrop.classList.remove('hidden');
                setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
            } else {
                drawer.classList.add('translate-x-full');
                backdrop.classList.add('opacity-0');
                setTimeout(() => backdrop.classList.add('hidden'), 300);
            }
        }

        function renderCartDrawer() {
            const container = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('cartSubtotal');

            if (AppState.cart.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <i class="bi bi-cart-x text-4xl mb-4"></i>
                    <p>Your cart is empty.</p>
                </div>`;
                subtotalEl.innerText = "GH₵0";
                return;
            }

            container.innerHTML = '';
            let total = 0;

            AppState.cart.forEach((item, idx) => {
                total += item.price * item.qty;
                const div = document.createElement('div');
                div.className = "flex gap-4";
                div.innerHTML = `
                    <img src="${formatImage(item.image)}" class="w-20 h-24 object-cover rounded-md bg-gray-100">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-sm line-clamp-2">${item.product_name}</h4>
                            <button onclick="removeFromCart(${idx})" class="text-gray-400 hover:text-red-500"><i class="bi bi-trash"></i></button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">${item.color} | ${item.size}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-semibold text-sm">${AppState.currency}${item.price}</span>
                            <div class="flex items-center border rounded-md">
                                <button onclick="updateQty(${idx}, -1)" class="px-2 py-1 text-gray-500 hover:bg-gray-100">-</button>
                                <span class="px-2 text-xs font-bold">${item.qty}</span>
                                <button onclick="updateQty(${idx}, 1)" class="px-2 py-1 text-gray-500 hover:bg-gray-100">+</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            subtotalEl.innerText = `${AppState.currency}${total}`;
        }

        function updateQty(idx, change) {
            const item = AppState.cart[idx];
            const newQty = item.qty + change;

            if (newQty < 1) {
                removeFromCart(idx);
                return;
            }
            if (newQty > item.maxQty) {
                alert(`Sorry, only ${item.maxQty} available.`);
                return;
            }

            item.qty = newQty;
            saveCart();
        }

        function removeFromCart(idx) {
            if (confirm("Remove this item?")) {
                AppState.cart.splice(idx, 1);
                saveCart();
            }
        }

        // --- 8. SEARCH & FILTER ---
        function toggleSearch() {
            const overlay = document.getElementById('searchOverlay');
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0', 'translate-y-[-10px]');
                    document.getElementById('searchInput').focus();
                }, 10);
            } else {
                overlay.classList.add('opacity-0', 'translate-y-[-10px]');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function populateFilters() {
            const cats = [...new Set(AppState.products.map(p => p.category))];
            const sel = document.getElementById('filterCategory');
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                sel.appendChild(opt);
            });
        }

        function performSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }

            const lowerQ = query.toLowerCase();
            const matches = AppState.products.filter(p =>
                p.product_name.toLowerCase().includes(lowerQ) ||
                p.parent_code.toLowerCase().includes(lowerQ) ||
                p.color_name.toLowerCase().includes(lowerQ)
            );

            // Filter duplicates (parents)
            const uniqueParents = [...new Map(matches.map(p => [p.parent_code, p])).values()];

            resultsContainer.innerHTML = uniqueParents.map(p => `
                <div class="cursor-pointer group" onclick="openProductModalFromSearch('${p.sub_code}')">
                    <img src="${formatImage(p.main_image_url)}" class="w-full aspect-[3/4] object-cover mb-2 rounded bg-gray-100">
                    <h4 class="font-bold text-sm line-clamp-1">${p.product_name}</h4>
                    <span class="text-xs text-gray-500">${p.category}</span>
                </div>
             `).join('');
        }

        function openProductModalFromSearch(subCode) {
            const prod = AppState.products.find(p => p.sub_code === subCode);
            if (prod) {
                toggleSearch();
                openProductModal(prod);
            }
        }

        // --- 10. CHECKOUT PLACEHOLDER ---
        function checkout() {
            if (AppState.cart.length === 0) return;
            alert("Proceeding to Checkout Page... (See phase 1 impl for full page logic)");
            // Here we would navigate to the checkout form (checkout.html or swap view)
            // For this rewrite, I'm keeping it Single Page. 
            // We can implement a clean Checkout Modal or Swap Main Content.
            // Given the scope, let's stick to the core "Add to Cart" loop first.
        }

        // --- SIZE GUIDE ---
        function openSizeGuide() {
            const cat = document.getElementById('modalCategory').innerText;
            // Simple alert for now or modal injection
            alert(`Size Guide for ${cat}: \nS: 36"\nM: 38"\nL: 40"\nXL: 42"`);
        }

        function scrollToGrid() {
            document.getElementById('productGrid').scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>

</html>
